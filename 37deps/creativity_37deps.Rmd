---
title: 'Part 2: Experimental Analysis'
date: "June 16, 2021`"
output:
  pdf_document:
    toc: yes
    toc_depth: 4
    keep_tex: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE, fig.retina = 4)
```


```{r}
# Libraries
pacman::p_load(tidyverse, haven, texreg, estimatr)


df_long <- 
  read_dta(here::here("37deps", "37copy.dta")) %>% 
  mutate(
    bfac_hours_teach_under = bfac_hours_teaching * bfac_undertcheffort,
    bfac_publications_dummy = if_else(bfac_publications > 0, 1, 0) # unused
  )

df <-
  df_long %>% 
  mutate(univcode = str_sub(department_id, 1, 5)) %>% 
  group_by(stdid, univcode, z_fluency, z_uniqueness, z_flexibility, female, age, father_college, mother_college, ses, b_i_jeemain_score_math, b_i_jeemain_score_phys, femaleb, femalemiss, ageb, agemiss, father_collegeb, father_collegemiss, mother_collegeb, mother_collegemiss, sesb, sesmiss, b_i_jeemain_scoreb, b_i_jeemain_scoremiss, b_i_jeemain_score_mathb, b_i_jeemain_score_mathmiss, b_i_jeemain_score_physb, b_i_jeemain_score_physmiss, reservation, classid, department_id, grade) %>% 
  summarize(
    # teach
    z_activefac = sum(x13 * credits, na.rm = TRUE) / sum(credits, na.rm = TRUE), # change as needed
    bfac_hours_teach_under = sum(bfac_hours_teach_under * credits, na.rm = TRUE) / sum(credits, na.rm = TRUE),
    bfac_hours_teaching = sum(bfac_hours_teaching * credits, na.rm = TRUE) / sum(credits, na.rm = TRUE),
    # research
    bfac_research_participation = sum(research_participation * credits, na.rm = TRUE) / sum(credits, na.rm = TRUE),
    bfac_hours_research = sum(bfac_hours_research * credits, na.rm = TRUE) / sum(credits, na.rm = TRUE),
    bfac_underrsch = sum(bfac_underrsch * credits, na.rm = TRUE) / sum(credits, na.rm = TRUE),
    bfac_publications = sum(bfac_publications * credits, na.rm = TRUE) / sum(credits, na.rm = TRUE),
    bfac_publications_dummy = sum(bfac_publications_dummy * credits, na.rm = TRUE) / sum(credits, na.rm = TRUE) # unused
  ) %>%
  ungroup() %>% 
  mutate_at(
    vars("z_activefac", "bfac_hours_teach_under", "bfac_hours_teaching", "bfac_research_participation", "bfac_hours_research", "bfac_underrsch", contains("score")),
    ~ scale(.) %>% as.vector
  ) %>% 
  mutate(
    bfac_log_publications = log(bfac_publications)
  )

# df %>% write_dta(here::here("37deps","test.dta"), version = 13)
```


\newpage


# Research results

## Fluency

```{r}
lm0 <-
  df %>% 
  lm_robust(z_fluency ~ bfac_log_publications + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid, data = .)

lm1 <-
  df %>% 
  lm_robust(z_fluency ~ bfac_log_publications + bfac_research_participation + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid,  data = .)

lm2 <-
  df %>% 
  lm_robust(z_fluency ~ bfac_log_publications + bfac_research_participation + bfac_hours_research + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid,  data = .)

lm3 <-
  df %>% 
  lm_robust(z_fluency ~ bfac_log_publications + bfac_research_participation + bfac_hours_research + bfac_underrsch + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid,  data = .)


screenreg(list(lm0, lm1, lm2, lm3), custom.note = "%stars \n All continuous variables are standardized. \n All models control for student background characteristics and department fixed effects.", omit.coef = "(female)|(college)|(ses)|(age)|(score)", include.ci = FALSE, stars = c(0.01, 0.05, 0.1))
```

\newpage

## Uniqueness

```{r}
lm0 <-
  df %>% 
  lm_robust(z_uniqueness ~ bfac_log_publications + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid, data = .)

lm1 <-
  df %>% 
  lm_robust(z_uniqueness ~ bfac_log_publications + bfac_research_participation + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid,  data = .)

lm2 <-
  df %>% 
  lm_robust(z_uniqueness ~ bfac_log_publications + bfac_research_participation + bfac_hours_research + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid,  data = .)

lm3 <-
  df %>% 
  lm_robust(z_uniqueness ~ bfac_log_publications + bfac_research_participation + bfac_hours_research + bfac_underrsch + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid,  data = .)


screenreg(list(lm0, lm1, lm2, lm3), custom.note = "%stars \n All continuous variables are standardized. \n All models control for student background characteristics and department fixed effects.", omit.coef = "(female)|(college)|(ses)|(age)|(score)", include.ci = FALSE, stars = c(0.01, 0.05, 0.1))
```

\newpage

## Flexibility

```{r}
lm0 <-
  df %>% 
  lm_robust(z_flexibility ~ bfac_log_publications + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid, data = .)

lm1 <-
  df %>% 
  lm_robust(z_flexibility ~ bfac_log_publications + bfac_research_participation + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid,  data = .)

lm2 <-
  df %>% 
  lm_robust(z_flexibility ~ bfac_log_publications + bfac_research_participation + bfac_hours_research + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid,  data = .)

lm3 <-
  df %>% 
  lm_robust(z_flexibility ~ bfac_log_publications + bfac_research_participation + bfac_hours_research + bfac_underrsch + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid,  data = .)


screenreg(list(lm0, lm1, lm2, lm3), custom.note = "%stars \n All continuous variables are standardized. \n All models control for student background characteristics and department fixed effects.", omit.coef = "(female)|(college)|(ses)|(age)|(score)", include.ci = FALSE, stars = c(0.01, 0.05, 0.1))
```



\newpage

# Teaching results

## Fluency

```{r}
lm1 <-
  df %>% 
  lm_robust(z_fluency ~ z_activefac + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid,  data = .)

lm2 <-
  df %>% 
  lm_robust(z_fluency ~ z_activefac + bfac_hours_teaching + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid,  data = .)

lm3 <-
  df %>% 
  lm_robust(z_fluency ~ z_activefac + bfac_hours_teaching + bfac_hours_teach_under + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid,  data = .)


screenreg(list(lm1, lm2, lm3), custom.note = "%stars \n All continuous variables are standardized. \n All models control for student background characteristics and department fixed effects.", omit.coef = "(female)|(college)|(ses)|(age)|(score)", include.ci = FALSE, stars = c(0.01, 0.05, 0.1))
```

\newpage

## Uniqueness

```{r}
lm1 <-
  df %>% 
  lm_robust(z_uniqueness ~ z_activefac + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid,  data = .)

lm2 <-
  df %>% 
  lm_robust(z_uniqueness ~ z_activefac + bfac_hours_teaching + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid,  data = .)

lm3 <-
  df %>% 
  lm_robust(z_uniqueness ~ z_activefac + bfac_hours_teaching + bfac_hours_teach_under + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid,  data = .)


screenreg(list(lm1, lm2, lm3), custom.note = "%stars \n All continuous variables are standardized. \n All models control for student background characteristics and department fixed effects.", omit.coef = "(female)|(college)|(ses)|(age)|(score)", include.ci = FALSE, stars = c(0.01, 0.05, 0.1))
```

\newpage

## Flexibility

```{r}
lm1 <-
  df %>% 
  lm_robust(z_flexibility ~ z_activefac + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid,  data = .)

lm2 <-
  df %>% 
  lm_robust(z_flexibility ~ z_activefac + bfac_hours_teaching + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid,  data = .)

lm3 <-
  df %>% 
  lm_robust(z_flexibility ~ z_activefac + bfac_hours_teaching + bfac_hours_teach_under + femaleb + femalemiss + ageb + agemiss + father_collegeb + father_collegemiss + mother_collegeb + mother_collegemiss + sesb + sesmiss + b_i_jeemain_score_mathb + b_i_jeemain_score_mathmiss + b_i_jeemain_score_physb + b_i_jeemain_score_physmiss, se_type = "stata", fixed_effects = ~ classid,  data = .)


screenreg(list(lm1, lm2, lm3), custom.note = "%stars \n All continuous variables are standardized. \n All models control for student background characteristics and department fixed effects.", omit.coef = "(female)|(college)|(ses)|(age)|(score)", include.ci = FALSE, stars = c(0.01, 0.05, 0.1))
```

\newpage

# Balance checks

## Research treatments

<br/>
Publications:

```{r}
df %>%
  lm_robust(bfac_log_publications ~ female + age + father_college + mother_college + ses + b_i_jeemain_score_math + b_i_jeemain_score_phys, se_type = "stata", fixed_effects = ~ department_id,  data = .) %>% 
  summary()
```

<br/>
Research participation:

```{r}
# randomization checks
df %>%
  lm_robust(bfac_research_participation ~ female + age + father_college + mother_college + ses, se_type = "stata", fixed_effects = ~ department_id,  data = .) %>%
  summary()
```

<br/>
Research hours:

```{r}
df %>%
  lm_robust(bfac_hours_research ~ female + age + father_college + mother_college + ses + b_i_jeemain_score_math + b_i_jeemain_score_phys, se_type = "stata", fixed_effects = ~ department_id,  data = .) %>% 
  summary()
```

<br/>
Undergrads work on research:

```{r}
df %>%
  lm_robust(bfac_underrsch ~ female + age + father_college + mother_college + ses + b_i_jeemain_score_math + b_i_jeemain_score_phys, se_type = "stata", fixed_effects = ~ department_id,  data = .) %>% 
  summary()
```

<br/>

\newpage

## Teaching treatments

<br/>
Active teaching:

```{r}
df %>%
  lm_robust(z_activefac ~ female + age + father_college + mother_college + ses + b_i_jeemain_score_math + b_i_jeemain_score_phys, se_type = "stata", fixed_effects = ~ department_id,  data = .) %>% 
  summary()
```

<br/>
Hours teaching:

```{r}
df %>%
  lm_robust(bfac_hours_teaching ~ female + age + father_college + mother_college + ses + b_i_jeemain_score_math + b_i_jeemain_score_phys, se_type = "stata", fixed_effects = ~ department_id,  data = .) %>% 
  summary()
```

<br/>
Hours teaching undergrads:

```{r}
df %>%
  lm_robust(bfac_hours_teach_under ~ female + age + father_college + mother_college + ses + b_i_jeemain_score_math + b_i_jeemain_score_phys, se_type = "stata", fixed_effects = ~ department_id,  data = .) %>% 
  summary()
```
